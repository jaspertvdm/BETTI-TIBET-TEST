; =============================================================================
; JIS TIBET/SNAFT Asterisk Dialplan - Intent-Based Call Routing
; =============================================================================
;
; Dit dialplan implementeert JIS semantic security voor telefonie:
; - TIBET token validatie (time-bounded intents)
; - SNAFT (System Not Authorized For That) intent-analyse
; - Humotica context validatie
; - Trust level routing
;
; INSTALLATIE:
; 1. Kopieer naar /etc/asterisk/extensions_tibet.conf
; 2. In extensions.conf: #include extensions_tibet.conf
; 3. Configureer AGI scripts (zie examples/asterisk/agi/)
; 4. Herlaad: asterisk -rx "dialplan reload"
;
; =============================================================================

; -----------------------------------------------------------------------------
; [tibet-inbound] - Inkomende calls met TIBET validatie
; -----------------------------------------------------------------------------
; Alle inkomende calls gaan eerst door TIBET/SNAFT validatie
; voordat ze naar de bestemming worden doorgeschakeld.

[tibet-inbound]
; Variabelen van SIP headers (X-TIBET-* headers)
exten => _X.,1,NoOp(=== JIS TIBET INBOUND VALIDATION ===)
 same => n,Set(TIBET_TOKEN=${SIP_HEADER(X-TIBET-Token)})
 same => n,Set(TIBET_VALID_UNTIL=${SIP_HEADER(X-TIBET-Valid-Until)})
 same => n,Set(CALLER_TRUST=${SIP_HEADER(X-JIS-Trust-Level)})
 same => n,Set(CALLER_INTENT=${SIP_HEADER(X-JIS-Intent)})
 same => n,Set(HUMOTICA_SENSE=${SIP_HEADER(X-Humotica-Sense)})
 same => n,Set(HUMOTICA_CONTEXT=${SIP_HEADER(X-Humotica-Context)})

 ; Log inkomende call info
 same => n,NoOp(Caller: ${CALLERID(num)}, Intent: ${CALLER_INTENT}, Trust: ${CALLER_TRUST})

 ; Stap 1: TIBET Token validatie via AGI
 same => n,AGI(tibet_validate.py,${TIBET_TOKEN},${TIBET_VALID_UNTIL})
 same => n,GotoIf($["${TIBET_VALID}" = "1"]?tibet_ok:tibet_fail)

 ; TIBET OK - ga door naar SNAFT check
 same => n(tibet_ok),NoOp(TIBET Token Valid)
 same => n,Goto(snaft-check,${EXTEN},1)

 ; TIBET FAIL - blokkeer of vraag om consent
 same => n(tibet_fail),NoOp(TIBET Token Invalid or Missing)
 same => n,Set(CALLER_TRUST=0)  ; Verlaag trust naar 0
 same => n,Goto(tibet-consent,${EXTEN},1)

; -----------------------------------------------------------------------------
; [tibet-consent] - TIBET consent flow voor calls zonder token
; -----------------------------------------------------------------------------
; Beller krijgt de kans om intent te verklaren via IVR

[tibet-consent]
exten => _X.,1,NoOp(=== TIBET CONSENT REQUIRED ===)
 same => n,Answer()
 same => n,Wait(1)

 ; Speel consent bericht
 same => n,Playback(tibet-consent-required)
 ; "Om deze persoon te bereiken moet u aangeven waarom u belt."

 ; Intent menu
 same => n,Background(tibet-intent-menu)
 ; "Druk 1 voor persoonlijk, 2 voor zakelijk, 3 voor urgent, 4 voor noodgeval"

 same => n,WaitExten(10)

 ; Timeout - geen consent
 same => n,Playback(tibet-no-consent)
 same => n,Hangup()

; Intent keuzes
exten => 1,1,Set(CALLER_INTENT=personal)
 same => n,Set(CALLER_TRUST=1)
 same => n,Goto(snaft-check,${ORIGINAL_EXTEN},1)

exten => 2,1,Set(CALLER_INTENT=business)
 same => n,Set(CALLER_TRUST=2)
 same => n,Goto(snaft-check,${ORIGINAL_EXTEN},1)

exten => 3,1,Set(CALLER_INTENT=urgent)
 same => n,Set(CALLER_TRUST=2)
 same => n,Set(CALL_PRIORITY=high)
 same => n,Goto(snaft-check,${ORIGINAL_EXTEN},1)

exten => 4,1,Set(CALLER_INTENT=emergency)
 same => n,Set(CALLER_TRUST=5)
 same => n,Set(CALL_PRIORITY=critical)
 same => n,Goto(snaft-check,${ORIGINAL_EXTEN},1)

exten => i,1,Playback(invalid)
 same => n,Goto(tibet-consent,${ORIGINAL_EXTEN},1)

exten => t,1,Playback(tibet-timeout)
 same => n,Hangup()

; -----------------------------------------------------------------------------
; [snaft-check] - SNAFT Intent Analysis
; -----------------------------------------------------------------------------
; Controleert of de intent toegestaan is voor deze beller/bestemming combinatie

[snaft-check]
exten => _X.,1,NoOp(=== SNAFT INTENT ANALYSIS ===)
 same => n,NoOp(Caller: ${CALLERID(num)}, Dest: ${EXTEN}, Intent: ${CALLER_INTENT}, Trust: ${CALLER_TRUST})

 ; AGI script voor SNAFT validatie
 ; Checkt tegen database van regels en blocklists
 same => n,AGI(snaft_validate.py,${CALLERID(num)},${EXTEN},${CALLER_INTENT},${CALLER_TRUST})

 ; SNAFT resultaat evalueren
 same => n,GotoIf($["${SNAFT_ALLOWED}" = "1"]?snaft_ok)
 same => n,GotoIf($["${SNAFT_BLOCKED}" = "1"]?snaft_blocked)
 same => n,GotoIf($["${SNAFT_REVIEW}" = "1"]?snaft_review)

 ; Default: doorlaten met logging
 same => n,Goto(snaft_ok)

 ; SNAFT OK - ga door naar BALANS risk check
 same => n(snaft_ok),NoOp(SNAFT: Intent Allowed)
 same => n,Goto(balans-check,${EXTEN},1)

 ; SNAFT BLOCKED - blokkeer call
 same => n(snaft_blocked),NoOp(SNAFT: Intent BLOCKED - ${SNAFT_REASON})
 same => n,Answer()
 same => n,Playback(snaft-blocked)
 ; "Dit gesprek kan niet worden voltooid. Uw verzoek is niet geautoriseerd."
 same => n,Hangup()

 ; SNAFT REVIEW - menselijke review nodig
 same => n(snaft_review),NoOp(SNAFT: Review Required)
 same => n,Goto(snaft-human-review,${EXTEN},1)

; -----------------------------------------------------------------------------
; [snaft-human-review] - HICSS Human Override
; -----------------------------------------------------------------------------
; Menselijke review voor edge cases

[snaft-human-review]
exten => _X.,1,NoOp(=== HICSS HUMAN REVIEW ===)
 same => n,Answer()
 same => n,Playback(snaft-review-required)
 ; "Een moment, uw verzoek wordt beoordeeld."

 ; Bel security/admin voor goedkeuring
 same => n,Set(REVIEW_CHANNEL=SIP/security)
 same => n,Dial(${REVIEW_CHANNEL},30,M(snaft-review-announce))

 ; Als goedgekeurd door reviewer
 same => n,GotoIf($["${SNAFT_OVERRIDE}" = "1"]?approved:denied)

 same => n(approved),NoOp(HICSS: Human Override Approved)
 same => n,Goto(balans-check,${EXTEN},1)

 same => n(denied),NoOp(HICSS: Human Override Denied)
 same => n,Playback(snaft-denied)
 same => n,Hangup()

; Macro voor review aankondiging
[macro-snaft-review-announce]
exten => s,1,Playback(snaft-review-request)
 ; "Inkomend gesprek van ${CALLERID(num)} naar ${EXTEN} met intent ${CALLER_INTENT}"
 same => n,Playback(press-1-approve)
 same => n,Read(REVIEW_RESPONSE,,1)
 same => n,GotoIf($["${REVIEW_RESPONSE}" = "1"]?approve:deny)
 same => n(approve),Set(SNAFT_OVERRIDE=1)
 same => n,Hangup()
 same => n(deny),Set(SNAFT_OVERRIDE=0)
 same => n,Hangup()

; -----------------------------------------------------------------------------
; [balans-check] - BALANS Risk Assessment
; -----------------------------------------------------------------------------
; Real-time risk scoring op basis van context

[balans-check]
exten => _X.,1,NoOp(=== BALANS RISK ASSESSMENT ===)

 ; AGI voor risk berekening
 same => n,AGI(balans_risk.py,${CALLERID(num)},${EXTEN},${CALLER_INTENT},${CALLER_TRUST})

 ; Risk threshold check (default 0.7)
 same => n,Set(RISK_THRESHOLD=0.7)
 same => n,GotoIf($["${BALANS_RISK}" > "${RISK_THRESHOLD}"]?high_risk:normal)

 same => n(high_risk),NoOp(BALANS: High Risk ${BALANS_RISK} - ${BALANS_REASON})
 ; Hoog risico: extra verificatie of blokkeren
 same => n,GotoIf($["${CALLER_TRUST}" >= "4"]?normal:block_risk)

 same => n(block_risk),Answer()
 same => n,Playback(balans-high-risk)
 same => n,Hangup()

 same => n(normal),NoOp(BALANS: Risk OK (${BALANS_RISK}))
 same => n,Goto(trust-routing,${EXTEN},1)

; -----------------------------------------------------------------------------
; [trust-routing] - Trust Level Based Routing
; -----------------------------------------------------------------------------
; Route calls op basis van trust level

[trust-routing]
exten => _X.,1,NoOp(=== TRUST LEVEL ROUTING ===)
 same => n,NoOp(Trust Level: ${CALLER_TRUST})

 ; Trust level routing
 same => n,GotoIf($["${CALLER_TRUST}" = "0"]?trust0)
 same => n,GotoIf($["${CALLER_TRUST}" = "1"]?trust1)
 same => n,GotoIf($["${CALLER_TRUST}" = "2"]?trust2)
 same => n,GotoIf($["${CALLER_TRUST}" = "3"]?trust3)
 same => n,GotoIf($["${CALLER_TRUST}" = "4"]?trust4)
 same => n,GotoIf($["${CALLER_TRUST}" = "5"]?trust5)
 same => n,Goto(trust1)  ; Default

 ; Trust 0: Unverified - alleen voicemail
 same => n(trust0),NoOp(Trust 0: Voicemail Only)
 same => n,Goto(voicemail,${EXTEN},1)

 ; Trust 1: Verified personal - normale routing
 same => n(trust1),NoOp(Trust 1: Normal Routing)
 same => n,Goto(normal-dial,${EXTEN},1)

 ; Trust 2: Business - met caller ID
 same => n(trust2),NoOp(Trust 2: Business Routing)
 same => n,Set(CALLERID(name)=[VERIFIED] ${CALLERID(name)})
 same => n,Goto(normal-dial,${EXTEN},1)

 ; Trust 3: High trust (bank, etc) - priority routing
 same => n(trust3),NoOp(Trust 3: Priority Routing)
 same => n,Set(CALLERID(name)=[TRUSTED] ${CALLERID(name)})
 same => n,Set(__QUEUE_PRIO=10)
 same => n,Goto(normal-dial,${EXTEN},1)

 ; Trust 4: Professional (lawyer, doctor)
 same => n(trust4),NoOp(Trust 4: Professional Routing)
 same => n,Set(CALLERID(name)=[PROFESSIONAL] ${CALLERID(name)})
 ; Optioneel: automatisch opnemen voor juridische doeleinden
 same => n,Set(__MIXMONITOR_FILENAME=/var/spool/asterisk/monitor/${UNIQUEID}.wav)
 same => n,MixMonitor(${MIXMONITOR_FILENAME})
 same => n,Goto(normal-dial,${EXTEN},1)

 ; Trust 5: Emergency/Government
 same => n(trust5),NoOp(Trust 5: Emergency Routing)
 same => n,Set(CALLERID(name)=[EMERGENCY] ${CALLERID(name)})
 same => n,Set(__QUEUE_PRIO=100)
 ; Bypass DND en andere filters
 same => n,Set(FORCE_RING=1)
 same => n,Goto(emergency-dial,${EXTEN},1)

; -----------------------------------------------------------------------------
; [normal-dial] - Standaard dial
; -----------------------------------------------------------------------------

[normal-dial]
exten => _X.,1,NoOp(=== NORMAL DIAL ===)
 same => n,NoOp(Dialing ${EXTEN} for ${CALLERID(num)})

 ; Log de call met JIS context
 same => n,AGI(jis_log_call.py,${UNIQUEID},${CALLERID(num)},${EXTEN},${CALLER_INTENT},${CALLER_TRUST})

 ; Dial met timeout
 same => n,Dial(SIP/${EXTEN},30,tT)
 same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy)
 same => n,GotoIf($["${DIALSTATUS}" = "NOANSWER"]?noanswer)
 same => n,GotoIf($["${DIALSTATUS}" = "CHANUNAVAIL"]?unavail)
 same => n,Hangup()

 same => n(busy),Playback(busy)
 same => n,Hangup()

 same => n(noanswer),Goto(voicemail,${EXTEN},1)

 same => n(unavail),Playback(unavail)
 same => n,Hangup()

; -----------------------------------------------------------------------------
; [emergency-dial] - Noodgeval routing (bypass filters)
; -----------------------------------------------------------------------------

[emergency-dial]
exten => _X.,1,NoOp(=== EMERGENCY DIAL ===)
 same => n,NoOp(EMERGENCY: ${CALLERID(num)} -> ${EXTEN})

 ; Log emergency call
 same => n,AGI(jis_log_call.py,${UNIQUEID},${CALLERID(num)},${EXTEN},emergency,5)

 ; Ring alle devices van gebruiker tegelijk
 same => n,Dial(SIP/${EXTEN}&SIP/${EXTEN}-mobile&SIP/${EXTEN}-backup,60,tT)
 same => n,Hangup()

; -----------------------------------------------------------------------------
; [voicemail] - Voicemail met TIBET context
; -----------------------------------------------------------------------------

[voicemail]
exten => _X.,1,NoOp(=== VOICEMAIL ===)
 same => n,Answer()
 same => n,Wait(1)

 ; Als beller trust 0 heeft, vertel ze om TIBET te gebruiken
 same => n,GotoIf($["${CALLER_TRUST}" = "0"]?lowtrustvm)

 same => n,VoiceMail(${EXTEN}@default,u)
 same => n,Hangup()

 same => n(lowtrustvm),Playback(tibet-voicemail-notice)
 ; "U bent niet geverifieerd. Laat een bericht achter of gebruik de JTel app voor directe verbinding."
 same => n,VoiceMail(${EXTEN}@default,u)
 same => n,Hangup()

; =============================================================================
; SNAFT REGELS VOORBEELDEN
; =============================================================================
; Deze worden door snaft_validate.py AGI geladen uit database
;
; Voorbeeld regels:
;
; 1. Blokkeer telemarketing naar particulieren na 21:00
;    IF caller_type=telemarketing AND time > 21:00 AND dest_type=residential
;    THEN block WITH reason="Telemarketing na 21:00 niet toegestaan"
;
; 2. Blokkeer spam nummers
;    IF caller IN spam_blocklist
;    THEN block WITH reason="Nummer op blocklist"
;
; 3. Vereist TIBET voor eerste contact met onbekend nummer
;    IF first_contact=true AND tibet_token=null
;    THEN require_consent
;
; 4. Auto-approve noodgevallen
;    IF intent=emergency
;    THEN allow WITH trust_override=5
;
; 5. Vereist HID attestation voor bank calls
;    IF dest_type=bank AND hid_attestation=null
;    THEN require_hid WITH reason="Bank vereist mens-verificatie"
;
; =============================================================================
